import{BehaviorSubject as e,Subject as t,AsyncSubject as s}from"rxjs";import{Vector3 as i,Mesh as n,BufferGeometry as r,MeshStandardMaterial as o,Box3 as a,Euler as h,Quaternion as l,PerspectiveCamera as d,AmbientLight as c,HemisphereLight as u,DirectionalLight as _,MeshPhysicalMaterial as m,NormalBlending as p,DoubleSide as g,Color as y,MeshPhongMaterial as M,MeshBasicMaterial as v,NoBlending as x,LineBasicMaterial as f,SpriteMaterial as S,CanvasTexture as w,Vector4 as b,Object3D as C,Vector2 as P,Raycaster as E,OrthographicCamera as k,Sprite as A,Scene as L,Uint32BufferAttribute as I,Uint8BufferAttribute as z,Float32BufferAttribute as B,WebGLRenderTarget as T,Matrix4 as R,InstancedBufferAttribute as $,Triangle as H,WebGLRenderer as D,sRGBEncoding as O,NoToneMapping as j}from"three";import{first as U}from"rxjs/operators";import{GLTFLoader as F}from"three/examples/jsm/loaders/GLTFLoader";import{DRACOLoader as V}from"three/examples/jsm/loaders/DRACOLoader";import{OrbitControls as Z}from"three/examples/jsm/controls/OrbitControls";import{LineGeometry as G}from"three/examples/jsm/lines/LineGeometry";import{Line2 as Y}from"three/examples/jsm/lines/Line2";import{LineMaterial as Q}from"three/examples/jsm/lines/LineMaterial";import{ConvexHull as N}from"three/examples/jsm/math/ConvexHull";class X{static get default(){return{downX:null,downY:null,maxDiff:10,mouseMoveTimer:null,waitForDouble:!1}}}class W{constructor(e,t,s,i=0){this.x=e,this.y=t,this.z=s,this.w=i}static getDistance(e,t){const s=t.x-e.x,i=t.y-e.y,n=t.z-e.z,r=Math.sqrt(s*s+i*i+n*n);return new W(s,i,n,r)}}class q{constructor(e=!1,t=0,s=0,i=0,n=0){this._x=t,this._w=n,e?(this._y=i,this._z=-s):(this._y=s,this._z=i)}get x(){return this._x}get w(){return this._w}get y_Yup(){return this._y}get z_Yup(){return this._z}get y_Zup(){return-this._z}get z_Zup(){return this._y}static fromVector3(e,t=!1){return e?new q(t,e.x,e.y,e.z):new q(t)}toVector3(e=!1){return e?new i(this.x,-this._z,this._y):new i(this._x,this._y,this._z)}toVec4(e=!1){return e?new W(this._x,-this._z,this._y,this._w):new W(this._x,this._y,this._z,this._w)}}class K{constructor(e,t){this.start=new W(e.x,e.y,e.z),this.end=new W(t.x,t.y,t.z),this.distance=W.getDistance(this.start,this.end)}}class J{constructor(e=null){this.useAntialiasing=!1,this.usePhysicalLights=!1,this.ambientLightIntensity=1,this.hemiLightIntensity=.4,this.dirLightIntensity=.6,this.highlightingEnabled=!0,this.highlightColor=16776960,this.selectionColor=16711680,this.isolationColor=5592405,this.isolationOpacity=.2,this.meshMergeType=null,this.fastRenderType=null,this.axesHelperEnabled=!0,this.axesHelperPlacement="top-right",this.axesHelperSize=128,null!=e&&Object.assign(this,e)}}class ee{constructor(e,t,s,i,n,r){this.r=e,this.g=t,this.b=s,this.roughness=i,this.metalness=n,this.opacity=r}get rByte(){return 255*this.r}get gByte(){return 255*this.g}get bByte(){return 255*this.b}get roughnessByte(){return 255*this.roughness}get metalnessByte(){return 255*this.metalness}get opacityByte(){return 255*this.opacity}static createFromMaterial(e){return new ee(e.color.r,e.color.g,e.color.b,e.roughness,e.metalness,e.opacity)}static deleteFromMesh(e,t=!1,s=!1){e[ee.prop]=null,t&&(e[ee.customProp]=null),s&&(e[ee.defaultProp]=null)}static getDefaultFromMesh(e){return e[ee.defaultProp]||(e[ee.defaultProp]=ee.createFromMaterial(e.material)),e[ee.defaultProp]}static getCustomFromMesh(e){return e[ee.customProp]}static getFromMesh(e){return e[ee.prop]?e[ee.prop]:e[ee.customProp]?e[ee.customProp]:ee.getDefaultFromMesh(e)}static setCustomToMesh(e,t){e[ee.customProp]=t}static setToMesh(e,t){e[ee.prop]=t}toString(){return`${this.r}|${this.g}|${this.b}|${this.roughness}|${this.metalness}|${this.opacity}`}}ee.prop="rgbrmo",ee.customProp="rgbrmoC",ee.defaultProp="rgbrmoD";var te=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{h(i.next(e))}catch(e){r(e)}}function a(e){try{h(i.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class se{constructor(s,i=null,n=null,r=null,o=null,a=null){this._loadingStateChange=new e(!1),this._modelLoadingStart=new t,this._modelLoadingEnd=new t,this._modelLoadingProgress=new t,this._modelsOpenedChange=new e([]),this._loadingInProgress=!1,this._loadingQueue=[],this._loadedModels=new Set,this._loadedModelsByGuid=new Map,this._loadedMeshes=new Set,this._loadedMeshesById=new Map,this._loadedModelsArray=[],this._loadedMeshesArray=[],this.onQueueLoaded=i,this.onModelLoaded=n,this.onModelUnloaded=r,this.onMeshLoaded=o,this.onMeshUnloaded=a,this.loadingStateChange$=this._loadingStateChange.asObservable(),this.modelLoadingStart$=this._modelLoadingStart.asObservable(),this.modelLoadingEnd$=this._modelLoadingEnd.asObservable(),this.modelLoadingProgress$=this._modelLoadingProgress.asObservable(),this.modelsOpenedChange$=this._modelsOpenedChange.asObservable();const h=new F;if(s){const e=new V;e.setDecoderPath(s),e.preload(),h.setDRACOLoader(e)}this._loader=h}get loadedModelsArray(){return this._loadedModelsArray}get loadedMeshesArray(){return this._loadedMeshesArray}get openedModelInfos(){return this._modelsOpenedChange.getValue()}get loadingInProgress(){return this._loadingInProgress}destroy(){var e,t;this._loadingStateChange.complete(),this._modelLoadingStart.complete(),this._modelLoadingProgress.complete(),this._modelLoadingEnd.complete(),this._modelsOpenedChange.complete(),null===(e=this._loadedMeshes)||void 0===e||e.forEach((e=>{e.geometry.dispose(),e.material.dispose()})),null===(t=this._loader.dracoLoader)||void 0===t||t.dispose(),this._loader=null}openModelsAsync(e){return te(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return[];const t=[];e.forEach((e=>{const i=new s;this._loadingQueue.push((()=>te(this,void 0,void 0,(function*(){const{url:t,guid:s,name:n}=e,r=this._loadedModelsByGuid.has(s)?{url:t,guid:s}:yield this.loadModel(t,s,n);i.next(r),i.complete()})))),t.push(i.pipe(U()).toPromise())})),this.processLoadingQueueAsync();return yield Promise.all(t)}))}closeModelsAsync(e){return te(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return;const t=[];e.forEach((e=>{const i=new s;this._loadingQueue.push((()=>te(this,void 0,void 0,(function*(){this.removeModelFromLoaded(e),i.next(!0),i.complete()})))),t.push(i.pipe(U()).toPromise())})),this.processLoadingQueueAsync(),yield Promise.all(t)}))}getLoadedMeshesById(e){return this._loadedMeshesById.get(e)}findMeshesByIds(e){const t=[],s=new Set;return e.forEach((e=>{const i=this.getLoadedMeshesById(e);(null==i?void 0:i.length)?t.push(...i):s.add(e)})),{found:t,notFound:s}}processLoadingQueueAsync(){return te(this,void 0,void 0,(function*(){if(this._loader&&!this._loadingInProgress&&this._loadingQueue.length){for(this._loadingInProgress=!0,this._loadingStateChange.next(!0);this._loadingQueue.length>0;){const e=this._loadingQueue.shift();yield e()}this.updateModelsDataArrays(),this.onQueueLoaded&&(yield this.onQueueLoaded()),this.emitOpenedModelsChanged(),this._loadingStateChange.next(!1),this._loadingInProgress=!1,yield this.processLoadingQueueAsync()}}))}loadModel(e,t,s){return te(this,void 0,void 0,(function*(){let i;this.onModelLoadingStart(e,t);try{const i=yield this._loader.loadAsync(e,(s=>this.onModelLoadingProgress(s,e,t)));this.addModelToLoaded(i,t,s)}catch(e){i=e}const n={url:e,guid:t,error:i};return this.onModelLoadingEnd(n),n}))}onModelLoadingStart(e,t){this._modelLoadingStart.next({url:e,guid:t})}onModelLoadingProgress(e,t,s){const i=Math.round(e.loaded/e.total*100);this._modelLoadingProgress.next({url:t,guid:s,progress:i})}onModelLoadingEnd(e){const{url:t,guid:s}=e;this._modelLoadingProgress.next({url:t,guid:s,progress:0}),this._modelLoadingEnd.next(e)}addModelToLoaded(e,t,s){const i=s||t,a=e.scene;a.userData.guid=t,a.name=i;const h=[],l=new Set;a.traverse((e=>{if(e instanceof n&&e.geometry instanceof r&&e.material instanceof o){const s=`${t}|${e.name}`;e.userData.id=s,e.userData.modelGuid=t,this._loadedMeshes.add(e),this._loadedMeshesById.has(s)?this._loadedMeshesById.get(s).push(e):this._loadedMeshesById.set(s,[e]),h.push(e),l.add(e.name),this.onMeshLoaded&&this.onMeshLoaded(e)}}));const d={name:i,meshes:h,handles:l};this._loadedModels.add(d),this._loadedModelsByGuid.set(t,d),this.onModelLoaded&&this.onModelLoaded(t)}removeModelFromLoaded(e){if(!this._loadedModelsByGuid.has(e))return;const t=this._loadedModelsByGuid.get(e);t.meshes.forEach((e=>{var t;this._loadedMeshes.delete(e),this._loadedMeshesById.delete(e.userData.id),this.onMeshUnloaded&&this.onMeshUnloaded(e),null===(t=e.geometry)||void 0===t||t.dispose()})),this._loadedModels.delete(t),this._loadedModelsByGuid.delete(e),this.onModelUnloaded&&this.onModelUnloaded(e)}updateModelsDataArrays(){this._loadedMeshesArray=[...this._loadedMeshes],this._loadedModelsArray=[...this._loadedModels]}emitOpenedModelsChanged(){const e=[];for(const[t,s]of this._loadedModelsByGuid)e.push({guid:t,name:s.name,handles:s.handles});this._modelsOpenedChange.next(e)}}class ie{constructor(e,t){this._focusBox=new a,this._rRadius=0,this._rPosFocus=new i,this._rPosRelCamTarget=new i,this._rPosRelCamTemp=new i,this._rEuler=new h,this._rQcfSource=new l,this._rQcfTarget=new l,this._rQcfTemp=new l,this._renderCb=t;const s=new d(75,1,1,1e4);s.position.set(0,1e3,1e3),s.lookAt(0,0,0);const n=new Z(s,e);n.addEventListener("change",this._renderCb),n.update(),this._camera=s,this._orbitControls=n}get camera(){return this._camera}destroy(){this._orbitControls.dispose()}resize(e,t){this._camera&&(this._camera.aspect=e/t,this._camera.updateProjectionMatrix())}rotateAroundAxis(e,t,s=!0){this.prepareForRotationAroundAxis(e,s),this.applyRotation(t)}focusCameraOnObjects(e,t=1.2){if(null==e?void 0:e.length){this._focusBox.makeEmpty();for(const t of e)this._focusBox.expandByObject(t);this.focusCameraOnBox(this._focusBox,t)}else this._focusBox.isEmpty()||this.focusCameraOnBox(this._focusBox,t)}focusCameraOnBox(e,t){const s=e.getSize(new i),n=e.getCenter(new i),r=Math.max(s.x,s.y,s.z)/(2*Math.atan(Math.PI*this._camera.fov/360)),o=r/this._camera.aspect,a=t*Math.max(r,o),h=this._orbitControls.target.clone().sub(this._camera.position).normalize().multiplyScalar(a);this._orbitControls.maxDistance=Math.max(10*a,1e4),this._orbitControls.target.copy(n),this._camera.near=Math.min(a/100,1),this._camera.far=Math.max(100*a,1e4),this._camera.updateProjectionMatrix(),this._camera.position.copy(n).sub(h),this._orbitControls.update()}prepareForRotationAroundAxis(e,t){switch(e){case"x":this._rPosRelCamTarget.set(1,0,0),this._rEuler.set(0,.5*Math.PI,0);break;case"y":t?(this._rPosRelCamTarget.set(0,0,-1),this._rEuler.set(0,Math.PI,0)):(this._rPosRelCamTarget.set(0,1,0),this._rEuler.set(-.5*Math.PI,0,0));break;case"z":t?(this._rPosRelCamTarget.set(0,1,0),this._rEuler.set(-.5*Math.PI,0,0)):(this._rPosRelCamTarget.set(0,0,1),this._rEuler.set(0,0,0));break;case"-x":this._rPosRelCamTarget.set(-1,0,0),this._rEuler.set(0,-.5*Math.PI,0);break;case"-y":t?(this._rPosRelCamTarget.set(0,0,1),this._rEuler.set(0,0,0)):(this._rPosRelCamTarget.set(0,-1,0),this._rEuler.set(.5*Math.PI,0,0));break;case"-z":t?(this._rPosRelCamTarget.set(0,-1,0),this._rEuler.set(.5*Math.PI,0,0)):(this._rPosRelCamTarget.set(0,0,-1),this._rEuler.set(0,Math.PI,0));break;default:return}this._rPosFocus.copy(this._orbitControls.target),this._rRadius=this._camera.position.distanceTo(this._rPosFocus),this._rPosRelCamTarget.multiplyScalar(this._rRadius),this._rQcfSource.copy(this._camera.quaternion),this._rQcfTarget.setFromEuler(this._rEuler)}applyRotation(e){if(e){const e=2*Math.PI,t=performance.now();let s,i;const n=()=>{s=(performance.now()-t)/1e3,i=s*e||.01,this._rQcfTemp.copy(this._rQcfSource).rotateTowards(this._rQcfTarget,i),this._rPosRelCamTemp.set(0,0,1).applyQuaternion(this._rQcfTemp).multiplyScalar(this._rRadius),this._camera.position.copy(this._rPosFocus).add(this._rPosRelCamTemp),this._orbitControls.target.copy(this._rPosFocus),this._orbitControls.update(),this._renderCb(),this._rQcfTemp.angleTo(this._rQcfTarget)&&window.requestAnimationFrame((()=>n()))};n()}else this._camera.position.copy(this._rPosFocus).add(this._rPosRelCamTarget),this._orbitControls.target.copy(this._rPosFocus),this._orbitControls.update(),this._renderCb()}}class ne{constructor(e,t,s,i){const n=new c(2236962,e?t*Math.PI:t);this._ambientLight=n;const r=new u(16777147,526368,e?s*Math.PI:s);r.position.set(0,2e3,0),this._hemisphereLight=r;const o=new _(16777215,e?i*Math.PI:i);o.position.set(-2,10,2),this._directionalLight=o}update(e,t,s,i){this._ambientLight.intensity=e?t*Math.PI:t,this._hemisphereLight.intensity=e?s*Math.PI:s,this._directionalLight.intensity=e?i*Math.PI:i}getLights(){return[this._ambientLight,this._hemisphereLight,this._directionalLight]}getCopy(){return[(new c).copy(this._ambientLight),(new u).copy(this._hemisphereLight),(new _).copy(this._directionalLight)]}}class re{static buildGlobalMaterial(){const e=new m({vertexColors:!0,flatShading:!0,blending:p,side:g,transparent:!0});return e.onBeforeCompile=e=>{e.vertexShader="\n        attribute vec3 rmo;        \n        varying float roughness;\n        varying float metalness;\n        varying float opacity;\n        "+e.vertexShader,e.vertexShader=e.vertexShader.replace("void main() {","\n        void main() {\n          roughness = rmo.x;\n          metalness = rmo.y;\n          opacity = rmo.z;\n        "),e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","varying float roughness;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","varying float metalness;"),e.fragmentShader=e.fragmentShader.replace("uniform float opacity;","varying float opacity;")},e}static buildIsolationColor(e,t){const s=new y(e);return new ee(s.r,s.g,s.b,1,0,t)}static buildStandardMaterial(e){return new m({blending:p,side:g,flatShading:!0,color:new y(e.r,e.g,e.b),transparent:1!==e.opacity,roughness:e.roughness,metalness:e.metalness,opacity:e.opacity})}static buildPhongMaterial(){return new M({color:8421504,transparent:!1,flatShading:!0,blending:p,side:g})}static buildBasicMaterial(e){return new v({color:e,flatShading:!0,blending:x,side:g})}static buildLineBasicMaterial(e,t){return new f({color:e,linewidth:t})}static buildLineMaterial(e,t,s){const i=new Q({color:e,linewidth:t});return s&&(i.dashed=!0,i.dashScale=.5,i.dashSize=1,i.gapSize=1,i.defines.USE_DASH="",i.needsUpdate=!0),i}static buildSpriteMaterial(e){return new S({map:e,toneMapped:!1})}}class oe{static buildAxisLabelTexture(e,t,s){const i=document.createElement("canvas");i.width=e,i.height=e;const n=i.getContext("2d");return n.beginPath(),n.arc(e/2,e/2,e/4,0,2*Math.PI),n.closePath(),n.fillStyle=new y(t).getStyle(),n.fill(),s&&(n.font=e/3+"px Arial",n.textAlign="center",n.textBaseline="top",n.fillStyle="#000000",n.fillText(s,e/2,e/2-e/6)),new w(i)}static buildSpriteAtlasTexture(){const e=document.createElement("canvas");e.width=128,e.height=128;const t=e.getContext("2d");oe.drawWarningSign(t,"gray",64,0,0),oe.drawWarningSign(t,"yellow",64,64,0),oe.drawWarningSign(t,"orange",64,0,64),oe.drawWarningSign(t,"red",64,64,64);const s=new Map;return s.set("warn_0",new b(0,.5,.5,1)),s.set("warn_1",new b(.5,.5,1,1)),s.set("warn_2",new b(0,0,.5,.5)),s.set("warn_3",new b(.5,0,1,.5)),{texture:new w(e),uvMap:s}}static buildCircleTexture(e,t){const s=document.createElement("canvas");s.width=e,s.height=e;const i=s.getContext("2d");return i.beginPath(),i.arc(e/2,e/2,e/2,0,2*Math.PI),i.closePath(),i.fillStyle=new y(t).getStyle(),i.fill(),new w(s)}static drawWarningSign(e,t,s,i,n){e.moveTo(i,n),e.fillStyle=t;const r=new Path2D(`\n      M ${.09375*s+i} ${.9375*s+n} \n      A ${.09375*s} ${.09375*s} 0 0 1 ${.0125*s+i} ${.796875*s+n}\n      L ${.41875*s+i} ${.07815*s+n} \n      A ${.09375*s} ${.09375*s} 0 0 1 ${.58046875*s+i} ${.078125*s+n} \n      L ${.9875*s+i} ${.796875*s+n} \n      A ${.09375*s} ${.09375*s} 0 0 1 ${.90625*s+i} ${.9375*s+n} \n      Z`);e.fill(r),e.fillStyle="white";const o=new Path2D(`\n      M ${.1953125*s+i} ${.8515625*s+n}\n      A ${.0703125*s} ${.0703125*s} 0 0 1 ${.134375*s+i} ${.74609375*s+n}\n      L ${.4390625*s+i} ${.2109375*s+n} \n      A ${.0703125*s} ${.0703125*s} 0 0 1 ${.5609375*s+i} ${.2109375*s+n}\n      L ${.865625*s+i} ${.74609375*s+n}\n      A ${.0703125*s} ${.0703125*s} 0 0 1 ${.8046875*s+i} ${.8515625*s+n} \n      Z`);e.fill(o),e.fillStyle="black";const a=new Path2D(`\n      M ${.4375*s+i} ${.3515625*s+n} \n      a ${.0625*s} ${.0625*s} 0 0 1 ${.125*s} 0\n      L ${.53125*s+i} ${.625*s+n} \n      a ${.0234375*s} ${.0234375*s} 0 0 1 ${-.046875*s} 0`);e.fill(a),e.moveTo(.5*s+i,.75*s+n),e.arc(.5*s+i,.75*s+n,.0625*s,0,2*Math.PI),e.fill()}}class ae extends C{constructor(e,t,s=!0,i="top-right",n=128){super(),this._clickPoint=new P,this._axisMaterials=new Array(3),this._axisLabelMaterials=new Array(6),this._axes=new Array(3),this._labels=new Array(6),this._viewportBak=new b,this.onDivPointerUp=e=>{if(!this.enabled)return;const{clientX:t,clientY:s}=e,{left:i,top:n,width:r,height:o}=this._div.getBoundingClientRect();this._clickPoint.set((t-i-r/2)/(r/2),-(s-n-o/2)/(o/2));const a=this.getIntersectionLabel();if(a){const e=a.userData.axis;this._axisCLickedCallback&&this._axisCLickedCallback(e)}},this._raycaster=new E,this._camera=new k(-2,2,2,-2,0,4),this._camera.position.set(0,0,2),this._container=e,this._axisCLickedCallback=t,this.initAxes(),this.updateOptions(s,i,n)}get size(){return this._size}set size(e){this.updateOptions(this.enabled,this._placement,e)}get placement(){return this._placement}set placement(e){this.updateOptions(this.enabled,e,this._size)}get enabled(){return this._enabled}set enabled(e){this.updateOptions(e,this._placement,this._size)}updateOptions(e,t,s){this._enabled=e,this._size=s,this._placement=t,this.initDiv()}destroy(){this.destroyDiv(),this.destroyAxes()}render(e,t,s=!0){if(this.enabled){switch(this.quaternion.copy(e.quaternion).inverse(),s&&this.quaternion.multiply(ae._toZUp),this.updateMatrixWorld(),t.getViewport(this._viewportBak),t.autoClear=!1,t.clearDepth(),this._placement){case"top-left":t.setViewport(0,t.getContext().drawingBufferHeight-this._size,this._size,this._size);break;case"top-right":t.setViewport(t.getContext().drawingBufferWidth-this._size,t.getContext().drawingBufferHeight-this._size,this._size,this._size);break;case"bottom-left":t.setViewport(0,0,this._size,this._size);break;case"bottom-right":t.setViewport(t.getContext().drawingBufferWidth-this._size,0,this._size,this._size)}t.render(this,this._camera),t.setViewport(this._viewportBak.x,this._viewportBak.y,this._viewportBak.z,this._viewportBak.w),t.autoClear=!0}}initAxes(){this._axisMaterials[0]=re.buildLineMaterial(16725587,.02,!1),this._axisMaterials[1]=re.buildLineMaterial(9100032,.02,!1),this._axisMaterials[2]=re.buildLineMaterial(2920447,.02,!1),this._axisLabelMaterials[0]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,16725587,"X")),this._axisLabelMaterials[1]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,10691125,"-X")),this._axisLabelMaterials[2]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,9100032,"Y")),this._axisLabelMaterials[3]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,5803008,"-Y")),this._axisLabelMaterials[4]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,2920447,"Z")),this._axisLabelMaterials[5]=re.buildSpriteMaterial(oe.buildAxisLabelTexture(64,1858467,"-Z")),this._axisGeometry=new G,this._axisGeometry.setPositions([0,0,0,.8,0,0]);const e=new Y(this._axisGeometry,this._axisMaterials[0]),t=new Y(this._axisGeometry,this._axisMaterials[1]),s=new Y(this._axisGeometry,this._axisMaterials[2]);t.rotation.z=Math.PI/2,s.rotation.y=-Math.PI/2,this.add(e),this.add(t),this.add(s),this._axes[0]=e,this._axes[1]=t,this._axes[2]=s;const i=new A(this._axisLabelMaterials[0]),n=new A(this._axisLabelMaterials[2]),r=new A(this._axisLabelMaterials[4]),o=new A(this._axisLabelMaterials[1]),a=new A(this._axisLabelMaterials[3]),h=new A(this._axisLabelMaterials[5]);i.userData.axis="x",n.userData.axis="y",r.userData.axis="z",o.userData.axis="-x",a.userData.axis="-y",h.userData.axis="-z",i.position.x=1,n.position.y=1,r.position.z=1,o.position.x=-1,a.position.y=-1,h.position.z=-1,o.scale.setScalar(.8),a.scale.setScalar(.8),h.scale.setScalar(.8),this.add(i),this.add(n),this.add(r),this.add(o),this.add(a),this.add(h),this._labels[0]=i,this._labels[1]=n,this._labels[2]=r,this._labels[3]=o,this._labels[4]=a,this._labels[5]=h}destroyAxes(){var e,t;this._axisGeometry.dispose(),null===(e=this._axisMaterials)||void 0===e||e.forEach((e=>e.dispose())),this._axisMaterials=null,null===(t=this._axisLabelMaterials)||void 0===t||t.forEach((e=>{e.map.dispose(),e.dispose()})),this._axisLabelMaterials=null}initDiv(){this.destroyDiv();const e=document.createElement("div");switch(e.style.position="absolute",e.style.height=this._size+"px",e.style.width=this._size+"px",this._placement){case"top-left":e.style.top="0px",e.style.left="0px";break;case"top-right":e.style.top="0px",e.style.right="0px";break;case"bottom-left":e.style.bottom="0px",e.style.left="0px";break;case"bottom-right":e.style.bottom="0px",e.style.right="0px"}e.addEventListener("pointerup",this.onDivPointerUp),this._container.append(e),this._div=e}destroyDiv(){this._div&&(this._div.removeEventListener("pointerup",this.onDivPointerUp),this._div.remove(),this._div=null)}getIntersectionLabel(){this._raycaster.setFromCamera(this._clickPoint,this._camera);const e=this._raycaster.intersectObjects(this._labels)[0];return e?e.object:null}}ae._toZUp=(new l).setFromAxisAngle(new i(1,0,0),-Math.PI/2);var he=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{h(i.next(e))}catch(e){r(e)}}function a(e){try{h(i.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class le{constructor(e,t,s,i){this._geometries=[],this._materials=new Map,this._geometryIndexBySourceMesh=new Map,this._sourceMeshesByGeometryIndex=new Map,this._renderMeshBySourceMesh=new Map,this._geometryIndicesNeedSort=new Set,this.updateCommonColors(e,t,s,i),this._globalMaterial=re.buildGlobalMaterial()}get scene(){return this._scene}get geometries(){return this._geometries}get meshes(){return[...this._renderMeshBySourceMesh.values()]}destroy(){this.destroyScene(),this.destroyMaterials()}updateSceneAsync(e,t,s,i){return he(this,void 0,void 0,(function*(){this.deleteScene(),yield this.createSceneAsync(e,t,s,i)}))}updateSceneMaterials(){this._globalMaterial.needsUpdate=!0,this._materials.forEach((e=>e.needsUpdate=!0))}updateMeshColors(e){this._currentMergeType?this.updateMeshGeometryColors(e):this.updateMeshMaterials(e),this.sortGeometryIndicesByOpacity()}updateCommonColors(e,t,s,i){this._isolationColor=re.buildIsolationColor(e,t),this._selectionColor=new y(s),this._highlightColor=new y(i)}deleteScene(){this._geometries.forEach((e=>e.geometry.dispose())),this._geometries.length=0,this._geometryIndexBySourceMesh.clear(),this._sourceMeshesByGeometryIndex.clear(),this._renderMeshBySourceMesh.clear(),this._geometryIndicesNeedSort.clear(),this._scene=null}createSceneAsync(e,t,s,i){return he(this,void 0,void 0,(function*(){const r=new L;if(r.add(...e),i){const e=yield this.groupModelMeshesByMergeType(t,s,i);for(const t of e)if(t.length){const e=yield this.buildRenderGeometryAsync(t);if(!e)continue;this._geometries.push(e);const s=this._geometries.length-1;this._sourceMeshesByGeometryIndex.set(s,t),this._geometryIndicesNeedSort.add(s),t.forEach((e=>{this._geometryIndexBySourceMesh.set(e,s)}))}this._geometries.forEach((e=>{const t=new n(e.geometry,this._globalMaterial);r.add(t)}))}else t.forEach((e=>{const t=ee.getFromMesh(e),s=this.getMaterialByColor(t),i=new n(e.geometry,s);i.applyMatrix4(e.matrix),this._renderMeshBySourceMesh.set(e,i),r.add(i)}));this._currentMergeType=i,this._scene=r}))}groupModelMeshesByMergeType(e,t,s){return he(this,void 0,void 0,(function*(){let i;switch(s){case"scene":i=[e];break;case"model":i=t.map((e=>e.meshes)).filter((e=>e.length));break;case"model+":i=[];const s=1e3;t.map((e=>e.meshes)).filter((e=>e.length)).forEach((e=>{if(e.length<=s)i.push(e);else for(let t=0;t<e.length;t+=s){const n=e.slice(t,t+s);i.push(n)}}));break;default:i=[]}return i}))}buildRenderGeometryAsync(e){return he(this,void 0,void 0,(function*(){let t=0,s=0;if(e.forEach((e=>{t+=3*e.geometry.getAttribute("position").count,s+=e.geometry.getIndex().count})),0===t)return null;const i=new I(new Uint32Array(s),1),n=new z(new Uint8Array(t),3,!0),o=new z(new Uint8Array(t),3,!0),a=new B(new Float32Array(t),3),h=new Map;let l=0,d=0;for(let t=0;t<e.length;t+=100)yield new Promise((s=>{setTimeout((()=>{e.slice(t,t+100).forEach((e=>{const t=e.geometry.clone().applyMatrix4(e.matrix),s=t.getAttribute("position").array,r=t.getIndex().array,c=new Uint32Array(r.length);h.set(e,c);for(let e=0;e<r.length;e++){const t=r[e]+l;i.setX(d++,t),c[e]=t}for(let t=0;t<s.length;){const i=ee.getFromMesh(e);n.setXYZ(l,i.rByte,i.gByte,i.bByte),o.setXYZ(l,i.roughnessByte,i.metalnessByte,i.opacityByte),a.setXYZ(l++,s[t++],s[t++],s[t++])}t.dispose()})),s()}),0)}));const c=new r;return c.setIndex(i),c.setAttribute("color",n),c.setAttribute("rmo",o),c.setAttribute("position",a),{geometry:c,positions:a,colors:n,rmos:o,indices:i,indicesBySourceMesh:h}}))}updateMeshMaterials(e){e.forEach((e=>{const{rgbRmo:t}=this.refreshMeshColors(e),s=this.getMaterialByColor(t);this._renderMeshBySourceMesh.get(e).material=s}))}updateMeshGeometryColors(e){const t=new Map;e.forEach((e=>{const s=this._geometryIndexBySourceMesh.get(e);t.has(s)?t.get(s).push(e):t.set(s,[e])})),t.forEach(((e,t)=>{this.updateGeometryColors(t,e)}))}updateGeometryColors(e,t){const s=this._geometries[e];if(!s)return;const{colors:i,rmos:n,indicesBySourceMesh:r}=s;let o=!1;t.forEach((e=>{const{rgbRmo:t,opacityChanged:s}=this.refreshMeshColors(e);r.get(e).forEach((e=>{i.setXYZ(e,t.rByte,t.gByte,t.bByte),n.setXYZ(e,t.roughnessByte,t.metalnessByte,t.opacityByte)})),!o&&s&&(o=!0)})),i.needsUpdate=!0,n.needsUpdate=!0,o&&this._geometryIndicesNeedSort.add(e)}sortGeometryIndicesByOpacity(){this._geometryIndicesNeedSort.forEach((e=>{const t=this._sourceMeshesByGeometryIndex.get(e),s=[],i=[];t.forEach((e=>{1===ee.getFromMesh(e).opacity?s.push(e):i.push(e)}));const{indices:n,indicesBySourceMesh:r}=this._geometries[e];let o=0;s.forEach((e=>{r.get(e).forEach((e=>{n.setX(o++,e)}))})),i.forEach((e=>{r.get(e).forEach((e=>{n.setX(o++,e)}))})),n.needsUpdate=!0})),this._geometryIndicesNeedSort.clear()}destroyScene(){var e;this._scene=null,null===(e=this._geometries)||void 0===e||e.forEach((e=>e.geometry.dispose())),this._geometries=null}getMaterialByColor(e){const t=e.toString();if(this._materials.has(t))return this._materials.get(t);const s=re.buildStandardMaterial(e);return this._materials.set(t,s),s}refreshMeshColors(e){const t=ee.getFromMesh(e);e.userData.isolated||ee.deleteFromMesh(e);const s=ee.getFromMesh(e);let i;return i=e.userData.highlighted?new ee(this._highlightColor.r,this._highlightColor.g,this._highlightColor.b,s.roughness,s.metalness,s.opacity):e.userData.selected?new ee(this._selectionColor.r,this._selectionColor.g,this._selectionColor.b,s.roughness,s.metalness,s.opacity):e.userData.isolated?this._isolationColor:s,ee.setToMesh(e,i),{rgbRmo:i,opacityChanged:i.opacity!==t.opacity}}destroyMaterials(){this._globalMaterial.dispose(),this._globalMaterial=null,this._materials.forEach((e=>e.dispose())),this._materials=null}}var de=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{h(i.next(e))}catch(e){r(e)}}function a(e){try{h(i.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class ce{constructor(){this._boxIndices=[0,1,3,3,1,2,1,5,2,2,5,6,5,4,6,6,4,7,4,0,7,7,0,3,3,2,7,7,2,6,4,5,0,0,5,1],this._geometries=[],this._simpleMaterial=re.buildPhongMaterial()}get scene(){return this._scene}get geometries(){return this._geometries}destroy(){var e;null===(e=this._geometries)||void 0===e||e.forEach((e=>e.dispose())),this._geometries=null,this._scene=null,this._simpleMaterial.dispose(),this._simpleMaterial=null}clearScene(){this._scene=null}updateSceneAsync(e,t,s){return de(this,void 0,void 0,(function*(){this._scene=null;const i=new L;let r;switch(i.add(...e),this._geometries.forEach((e=>e.dispose())),this._geometries.length=0,s){case"ch":r=yield this.buildHullGeometryAsync(t);break;case"aabb":r=yield this.buildBoxGeometryAsync(t);break;case"ombb":default:throw new Error("Render type not implemented")}r&&this._geometries.push(r),this._geometries.forEach((e=>{const t=new n(e,this._simpleMaterial);i.add(t)})),this._scene=i}))}updateSceneMaterials(){this._simpleMaterial.needsUpdate=!0}buildHullGeometryAsync(e){return de(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return null;const t=[];for(let s=0;s<e.length;s+=100)yield new Promise((i=>{setTimeout((()=>{e.slice(s,s+100).forEach((e=>{try{(new N).setFromObject(e).faces.forEach((e=>{let s=e.edge;do{t.push(s.head().point),s=s.next}while(s!==e.edge)}))}catch(e){}})),i()}),0)}));const s=new Uint32Array(t.length);let i=0;const n=new Map,o=[];t.forEach(((e,t)=>{const r=`${e.x}|${e.y}|${e.z}`;n.has(r)?s[t]=n.get(r):(s[t]=i,n.set(r,i++),o.push(e))}));const a=new Float32Array(3*o.length);let h=0;o.forEach((e=>{a[h++]=e.x,a[h++]=e.y,a[h++]=e.z}));const l=new B(a,3),d=new I(s,1),c=new r;return c.setAttribute("position",l),c.setIndex(d),c}))}buildBoxGeometryAsync(e){return de(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return null;const t=new Float32Array(8*e.length*3),s=new Uint32Array(12*e.length*3);let i=0,n=0;const o=e=>{e.forEach((e=>{const r=this.getMeshBoxPositions(e),o=i/3;for(let e=0;e<r.length;e++)t[i++]=r[e];this._boxIndices.forEach((e=>s[n++]=o+e))}))};for(let t=0;t<e.length;t+=100)yield new Promise((s=>{setTimeout((()=>{o(e.slice(t,t+100)),s()}),0)}));const a=new B(t,3),h=new I(s,1),l=new r;return l.setAttribute("position",a),l.setIndex(h),l}))}getMeshBoxPositions(e){const t=(new a).setFromBufferAttribute(e.geometry.getAttribute("position")),s=new Float32Array(24);s[0]=t.min.x,s[1]=t.min.y,s[2]=t.max.z,s[3]=t.max.x,s[4]=t.min.y,s[5]=t.max.z,s[6]=t.max.x,s[7]=t.max.y,s[8]=t.max.z,s[9]=t.min.x,s[10]=t.max.y,s[11]=t.max.z,s[12]=t.min.x,s[13]=t.min.y,s[14]=t.min.z,s[15]=t.max.x,s[16]=t.min.y,s[17]=t.min.z,s[18]=t.max.x,s[19]=t.max.y,s[20]=t.min.z,s[21]=t.min.x,s[22]=t.max.y,s[23]=t.min.z;return new B(s,3).applyMatrix4(e.matrix).array}}class ue{constructor(){this._lastPickingColor=0,this._materials=[],this._releasedMaterials=[],this._pickingMeshById=new Map,this._sourceMeshByPickingColor=new Map;const e=new L;e.background=new y(0),this._scene=e,this._target=new T(1,1)}destroy(){this._materials.forEach((e=>e.dispose())),this._materials=null,this._target.dispose(),this._target=null}add(e){const t=this.getMaterial(),s=t.color.getHex().toString(16),i=new n(e.geometry,t);i.userData.sourceId=e.userData.id,i.userData.sourceUuid=e.uuid,i.userData.color=s,i.position.copy(e.position),i.rotation.copy(e.rotation),i.scale.copy(e.scale),this._scene.add(i),this._pickingMeshById.set(e.uuid,i),this._sourceMeshByPickingColor.set(s,e)}remove(e){const t=this._pickingMeshById.get(e.uuid);t&&(this._scene.remove(t),this._pickingMeshById.delete(e.uuid),this._sourceMeshByPickingColor.delete(t.userData.color),this.releaseMaterial(t.material))}getSourceMeshAt(e,t,s){return this.getSourceMeshAtPosition(e,t,s)}getPickingMeshAt(e,t,s){const i=this.getSourceMeshAtPosition(e,t,s);return i?this._pickingMeshById.get(i.uuid):null}getSourceMeshAtPosition(e,t,s){const i=t.getContext();e.setViewOffset(i.drawingBufferWidth,i.drawingBufferHeight,s.x,s.y,1,1),t.setRenderTarget(this._target),t.render(this._scene,e),t.setRenderTarget(null),e.clearViewOffset();const n=new Uint8Array(4);t.readRenderTargetPixels(this._target,0,0,1,1,n);const r=(n[0]<<16|n[1]<<8|n[2]).toString(16);return this._sourceMeshByPickingColor.get(r)}nextPickingColor(){return 16777215===this._lastPickingColor&&(this._lastPickingColor=0),++this._lastPickingColor}getMaterial(){if(this._releasedMaterials.length)return this._releasedMaterials.pop();const e=new y(this.nextPickingColor()),t=new v({color:e,flatShading:!0,blending:x,side:g});return this._materials.push(t),t}releaseMaterial(e){this._releasedMaterials.push(e)}}class _e{constructor(e,t,s,i,n,r,o,a=1e4){const h=re.buildSpriteMaterial(s);h.onBeforeCompile=s=>{s.uniforms=Object.assign({},s.uniforms,{hudMatrix:{value:e},resolution:{value:t}}),s.vertexShader=s.vertexShader.replace("void main() {","\n        uniform vec2 resolution;\n        uniform mat4 hudMatrix;\n        attribute vec3 instancePosition;\n        attribute vec4 instanceUv;\n        attribute float instanceScale;\n\n        vec3 applyMatrix4(vec3 vec, mat4 mat) {\n          vec3 result = vec3(0.0);\n          float w = 1.0 / (mat[0].w * vec.x + mat[1].w * vec.y + mat[2].w * vec.z + mat[3].w);\n          result .x = (mat[0].x * vec.x + mat[1].x * vec.y + mat[2].x * vec.z + mat[3].x) * w;\n          result .y = (mat[0].y * vec.x + mat[1].y * vec.y + mat[2].y * vec.z + mat[3].y) * w;\n          result .z = (mat[0].z * vec.x + mat[1].z * vec.y + mat[2].z * vec.z + mat[3].z) * w;\n          return result;\t\t\t\n        }\n\n        void main() {\n      "),s.vertexShader=s.vertexShader.replace("#include <uv_vertex>","\n        #ifdef USE_UV\n          vec2 iUv = vec2(uv.x == 0.0 ? instanceUv.x : instanceUv.z, uv.y == 0.0 ? instanceUv.y : instanceUv.w);          \n          vUv = (uvTransform * vec3(iUv, 1)).xy;\n        #endif\n      "),s.vertexShader=s.vertexShader.replace("vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );",""),s.vertexShader=s.vertexShader.replace("#ifndef USE_SIZEATTENUATION",` \n          scale.x *= instanceScale;\n          scale.y *= instanceScale;\n\n          vec3 hudPosition = applyMatrix4(instancePosition, hudMatrix);\n          if (hudPosition.z > 1.0) {\n            gl_Position = vec4(0.0, 0.0, 0.0, -1.0);\n            return;\n          }\n          hudPosition.z = ${(n-r).toFixed()}.0;\n        `+(o?"\n            vec2 halfRes = resolution * 0.5;\n            if (hudPosition.x > halfRes.x) {\n              hudPosition.x = halfRes.x - scale.x * 0.5;\n            } else if (hudPosition.x < -halfRes.x) {\n              hudPosition.x = -halfRes.x + scale.x * 0.5;\n            }\n            if (hudPosition.y > halfRes.y) {\n              hudPosition.y = halfRes.y - scale.y * 0.5;\n            } else if (hudPosition.y < -halfRes.y) {\n              hudPosition.y = -halfRes.y + scale.y * 0.5;\n            }\n          ":"")+"\n          vec4 mvPosition = mat4(\n            modelViewMatrix[0], \n            modelViewMatrix[1], \n            modelViewMatrix[2], \n            vec4(hudPosition, 1)\n          ) * vec4(0.0, 0.0, 0.0, 1.0);\n\n          #ifndef USE_SIZEATTENUATION\n        ")};const l=new A(h);l.geometry=l.geometry.clone(),l.geometry.setAttribute("instancePosition",new $(new Float32Array(3*a),3)),l.geometry.setAttribute("instanceUv",new $(new Float32Array(4*a),4)),l.geometry.setAttribute("instanceScale",new $(new Float32Array(a),1)),l.geometry.isInstancedBufferGeometry=!1,l.geometry.instanceCount=0,l.frustumCulled=!1,l.visible=!1,l.scale.set(i,i,1),l.position.set(0,0,0),this._sprite=l}get object3d(){return this._sprite}update(){}destroy(){this._sprite.geometry.dispose(),this._sprite=null}set(e){const t=this._sprite.geometry.getAttribute("instancePosition"),s=this._sprite.geometry.getAttribute("instanceUv"),i=this._sprite.geometry.getAttribute("instanceScale"),n=t.count;(null==e?void 0:e.length)?(e.length>n&&(e=e.slice(0,n)),this._sprite.geometry.isInstancedBufferGeometry=!0,this._sprite.geometry.instanceCount=e.length,e.forEach(((e,n)=>{var r;e.position?t.setXYZ(n,e.position.x,e.position.y_Yup,e.position.z_Yup):t.setXYZ(n,0,0,0),e.uv?s.setXYZW(n,e.uv.x,e.uv.y,e.uv.z,e.uv.w):s.setXYZW(n,0,0,1,1),i.setX(n,null!==(r=e.scale)&&void 0!==r?r:1)})),t.needsUpdate=!0,s.needsUpdate=!0,i.needsUpdate=!0,this._sprite.visible=!0):this.reset()}reset(){this._sprite.visible&&(this._sprite.visible=!1,this._sprite.geometry.isInstancedBufferGeometry=!1,this._sprite.geometry.instanceCount=0)}}class me{constructor(e,t,s,i,n){const r=re.buildSpriteMaterial(t);r.onBeforeCompile=t=>{t.uniforms=Object.assign({},t.uniforms,{hudMatrix:{value:e}}),t.vertexShader=t.vertexShader.replace("void main() {","\n        uniform mat4 hudMatrix;\n\n        vec3 applyMatrix4(vec3 vec, mat4 mat) {\n          vec3 result = vec3(0.0);\n          float w = 1.0 / (mat[0].w * vec.x + mat[1].w * vec.y + mat[2].w * vec.z + mat[3].w);\n          result .x = (mat[0].x * vec.x + mat[1].x * vec.y + mat[2].x * vec.z + mat[3].x) * w;\n          result .y = (mat[0].y * vec.x + mat[1].y * vec.y + mat[2].y * vec.z + mat[3].y) * w;\n          result .z = (mat[0].z * vec.x + mat[1].z * vec.y + mat[2].z * vec.z + mat[3].z) * w;\n          return result;\t\t\t\n        }\n\n        void main() {\n      "),t.vertexShader=t.vertexShader.replace("vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );",` \n          vec3 globalPosition = modelMatrix[3].xyz;\n          vec3 hudPosition = applyMatrix4(globalPosition, hudMatrix);\n          if (hudPosition.z > 1.0) {\n            hudPosition.x = -hudPosition.x;\n            hudPosition.y = -hudPosition.y;\n          }\n          hudPosition.z = ${(i-n).toFixed()}.0;\n\n          vec4 mvPosition = mat4(\n            modelViewMatrix[0], \n            modelViewMatrix[1], \n            modelViewMatrix[2], \n            vec4(hudPosition, 1)\n          ) * vec4( 0.0, 0.0, 0.0, 1.0 );\n        `)};const o=new A(r);o.visible=!1,o.scale.set(s,s,1),o.position.set(0,0,0),o.frustumCulled=!1,this._sprite=o}get object3d(){return this._sprite}update(){}destroy(){this._sprite.material.dispose(),this._sprite=null}set(e){1===(null==e?void 0:e.length)?(this._sprite.position.copy(e[0]),this._sprite.visible=!0):this.reset()}reset(){this._sprite.visible&&(this._sprite.visible=!1,this._sprite.position.set(0,0,0))}}class pe{constructor(e,t,s,i,n,r=!1){this._hudResolution=t;const o=re.buildLineMaterial(s,i,r);o.onBeforeCompile=t=>{t.uniforms=Object.assign({},t.uniforms,{hudMatrix:{value:e}}),t.vertexShader=t.vertexShader.replace("void main() {",`\n        uniform mat4 hudMatrix;\n\n        vec3 applyMatrix4(vec3 vec, mat4 mat) {\n          vec3 result = vec3(0.0);\n          float w = 1.0 / (mat[0].w * vec.x + mat[1].w * vec.y + mat[2].w * vec.z + mat[3].w);\n          result .x = (mat[0].x * vec.x + mat[1].x * vec.y + mat[2].x * vec.z + mat[3].x) * w;\n          result .y = (mat[0].y * vec.x + mat[1].y * vec.y + mat[2].y * vec.z + mat[3].y) * w;\n          result .z = (mat[0].z * vec.x + mat[1].z * vec.y + mat[2].z * vec.z + mat[3].z) * w;\n          return result;\t\t\t\n        }\n\n        void main() {\n          vec3 hudStart = applyMatrix4(instanceStart, hudMatrix);\n          if (hudStart.z > 1.0) {\n            hudStart.x = -hudStart.x;\n            hudStart.y = -hudStart.y;\n          }\n          hudStart.z = ${n}.0;\n\n          vec3 hudEnd = applyMatrix4(instanceEnd, hudMatrix);\n          if (hudEnd.z > 1.0) {\n            hudEnd.x = -hudEnd.x;\n            hudEnd.y = -hudEnd.y;\n          }\n          hudEnd.z = ${n}.0;\n\n          float hudDistanceStart = 0.0;\n          float hudDistanceEnd = length(hudEnd - hudStart);\n      `),t.vertexShader=t.vertexShader.replace("vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;","vLineDistance = ( position.y < 0.5 ) ? dashScale * hudDistanceStart : dashScale * hudDistanceEnd;"),t.vertexShader=t.vertexShader.replace("vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );","vec4 start = modelViewMatrix * vec4( hudStart, 1.0 );"),t.vertexShader=t.vertexShader.replace("vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );","vec4 end = modelViewMatrix * vec4( hudEnd, 1.0 );")};const a=new G;a.setPositions(new Array(6).fill(0));const h=new Y(a,o);h.frustumCulled=!1,h.visible=!1,this._segment=h}get object3d(){return this._segment}update(){this._segment.material.resolution.copy(this._hudResolution)}destroy(){this._segment.geometry.dispose(),this._segment.material.dispose(),this._segment=null}set(e){if(2!==(null==e?void 0:e.length))return void this.reset();const[t,s]=e;this._segment.visible||(this._segment.visible=!0),this._segment.geometry.setPositions([t.x,t.y,t.z,s.x,s.y,s.z])}reset(){this._segment.visible&&(this._segment.visible=!1,this._segment.geometry.setPositions(new Array(6).fill(0)))}}class ge{constructor(e,t,s,i,n){this._hudResolution=new P,this._hudProjectionMatrix=new R,this._subjects=[],this._hudElements=new Map,this._hudScene=e,this._hudResolution=t,this._hudProjectionMatrix=s,this._toolZIndex=i,this._cameraZIndex=n}destroy(){this.destroyHudElements(),this._subjects.forEach((e=>e.complete()))}update(){this._hudElements.forEach((e=>e.update()))}getHudElement(e){return this._hudElements.get(e)}addHudElement(e,t){(null==e?void 0:e.object3d)&&(this._hudElements.has(t)&&this.removeHudElement(t),this._hudElements.set(t,e),this._hudScene.add(e.object3d))}removeHudElement(e){const t=this._hudElements.get(e);t&&(this._hudScene.remove(t.object3d),t.destroy(),this._hudElements.delete(e))}clearHudElements(){this._hudElements.forEach((e=>{this._hudScene.remove(e.object3d),e.destroy()})),this._hudElements.clear()}destroyHudElements(){this._hudElements.forEach((e=>{this._hudScene.remove(e.object3d),e.destroy()})),this._hudElements=null}}class ye extends ge{constructor(s,i,n,r,o){super(s,i,n,r,o),this._selectedPoints=new Map,this._snapPointHighlightChange=new t,this._snapPointManualSelectionChange=new e([]),this._subjects.push(this._snapPointHighlightChange,this._snapPointManualSelectionChange),this.snapPointHighlightChange$=this._snapPointHighlightChange.asObservable(),this.snapPointManualSelectionChange$=this._snapPointManualSelectionChange.asObservable(),this.initSprites()}setSnapPoint(e){e?(this.getHudElement("s_snap").set([e.position.toVector3()]),this._snapPointHighlightChange.next(e)):(this.getHudElement("s_snap").reset(),this._snapPointHighlightChange.next(null))}resetSnapPoint(){this._snapPointHighlightChange.next(null),this.getHudElement("s_snap").reset()}addSnapPointToSelected(e){e&&(this._selectedPoints.set(`${e.position.x}|${e.position.y_Yup}|${e.position.z_Yup}|${e.meshId}`,e),this.updateSelectedPointSprites())}removeSnapPointFromSelected(e){if(!e)return;const t=`${e.position.x}|${e.position.y_Yup}|${e.position.z_Yup}|${e.meshId}`;this._selectedPoints.has(t)&&(this._selectedPoints.delete(t),this.updateSelectedPointSprites())}setSelectedSnapPoints(e){(null==e?void 0:e.length)?(this._selectedPoints.clear(),e.forEach((e=>{this._selectedPoints.set(`${e.position.x}|${e.position.y_Yup}|${e.position.z_Yup}|${e.meshId}`,e)})),this.updateSelectedPointSprites()):this.resetSelectedSnapPoints()}resetSelectedSnapPoints(){this._selectedPoints.clear(),this.updateSelectedPointSprites()}reset(){this.resetSelectedSnapPoints(),this.resetSnapPoint()}initSprites(){this.addHudElement(new _e(this._hudProjectionMatrix,this._hudResolution,oe.buildCircleTexture(64,9109504),8,this._toolZIndex,this._cameraZIndex,!1),"s_snap_selection"),this.addHudElement(new me(this._hudProjectionMatrix,oe.buildCircleTexture(64,16711935),8,this._toolZIndex,this._cameraZIndex),"s_snap")}updateSelectedPointSprites(){const e=new Array(this._selectedPoints.size),t=new Array(this._selectedPoints.size);let s=0;this._selectedPoints.forEach((i=>{e[s]=i,t[s++]={position:i.position,scale:1,uv:null}})),this.getHudElement("s_snap_selection").set(t),this._snapPointManualSelectionChange.next(e)}}class Me extends ge{constructor(e,s,i,n,r){super(e,s,i,n,r),this._measurePoints={start:null,end:null},this._distanceMeasureChange=new t,this._subjects.push(this._distanceMeasureChange),this.distanceMeasureChange$=this._distanceMeasureChange.asObservable(),this.initLines(),this.initSprites()}setEndMarker(e){if(e?this._measurePoints.end?(this._measurePoints.start=this._measurePoints.end,this._measurePoints.end=e):this._measurePoints.start?this._measurePoints.end=e:this._measurePoints.start=e:(this._measurePoints.start&&(this._measurePoints.start=null),this._measurePoints.end&&(this._measurePoints.end=null)),this._measurePoints.start?this.getHudElement("s_dm_start").set([this._measurePoints.start]):this.getHudElement("s_dm_start").reset(),this._measurePoints.end?(this.getHudElement("s_dm_end").set([this._measurePoints.end]),this.setLines(!0)):(this.getHudElement("s_dm_end").reset(),this.resetLines()),this._measurePoints.start&&this._measurePoints.end){const e=q.fromVector3(this._measurePoints.start),t=q.fromVector3(this._measurePoints.end),s=new K(e.toVec4(!0),t.toVec4(!0));this._distanceMeasureChange.next(s)}else this._distanceMeasureChange.next(null)}reset(){this._measurePoints.start=null,this._measurePoints.end=null,this._distanceMeasureChange.next(null),this.resetSprites(),this.resetLines()}initLines(){this.addHudElement(new pe(this._hudProjectionMatrix,this._hudResolution,2920447,2,this._toolZIndex,!0),"l_dm_z"),this.addHudElement(new pe(this._hudProjectionMatrix,this._hudResolution,9100032,2,this._toolZIndex,!0),"l_dm_y"),this.addHudElement(new pe(this._hudProjectionMatrix,this._hudResolution,16725587,2,this._toolZIndex,!0),"l_dm_x"),this.addHudElement(new pe(this._hudProjectionMatrix,this._hudResolution,255,4,this._toolZIndex),"l_dm_w")}setLines(e){const t=this._measurePoints.start,s=this._measurePoints.end,n=(new i).copy(s).sub(t),r=new i(t.x+n.x,t.y,t.z),o=e?new i(r.x,r.y,r.z+n.z):new i(r.x,r.y+n.y,r.z);this.getHudElement("l_dm_z").set([o,s]),this.getHudElement("l_dm_y").set([r,o]),this.getHudElement("l_dm_x").set([t,r]),this.getHudElement("l_dm_w").set([t,s])}resetLines(){this.getHudElement("l_dm_z").reset(),this.getHudElement("l_dm_y").reset(),this.getHudElement("l_dm_x").reset(),this.getHudElement("l_dm_w").reset()}initSprites(){this.addHudElement(new me(this._hudProjectionMatrix,oe.buildCircleTexture(64,3740293),8,this._toolZIndex,this._cameraZIndex),"s_dm_start"),this.addHudElement(new me(this._hudProjectionMatrix,oe.buildCircleTexture(64,65535),8,this._toolZIndex,this._cameraZIndex),"s_dm_end")}resetSprites(){this.getHudElement("s_dm_start").reset(),this.getHudElement("s_dm_end").reset()}}class ve extends ge{constructor(s,n,r,o,a){super(s,n,r,o,a),this._spriteSize=16,this._markers=[],this._selectedMarkerIds=new Set,this._tempVec3=new i,this._tempVec2=new P,this._markersChange=new e([]),this._markersManualSelectionChange=new e([]),this._markersHighlightChange=new t,this._subjects.push(this._markersChange,this._markersManualSelectionChange,this._markersHighlightChange),this.markersChange$=this._markersChange.asObservable(),this.markersManualSelectionChange$=this._markersManualSelectionChange.asObservable(),this.markersHighlightChange$=this._markersHighlightChange.asObservable(),this.initSprites()}addMarker(e){if(!e)return;this._markers.find((t=>t.id===e.id))||(this._markers.push(e),this.emitMarkers(),this.updateSprites())}removeMarker(e){e&&(this._markers=this._markers.filter((t=>t.id!==e)),this._selectedMarkerIds.delete(e)&&this.emitSelected(),this.emitMarkers(),this.updateSprites())}setMarkers(e){(null==e?void 0:e.length)?(this._markers=e,this._selectedMarkerIds.size&&(this._selectedMarkerIds.clear(),this.emitSelected()),this.emitMarkers(),this.updateSprites()):this.resetMarkers()}resetMarkers(){this._selectedMarkerIds.size&&(this._selectedMarkerIds.clear(),this.emitSelected()),this._markers.length&&(this._markers.length=0,this.emitMarkers()),this.updateSprites()}highlightMarker(e){e!==this._highlightedMarker&&(this._highlightedMarker=e,this.emitHighlighted(),this.updateSprites())}addMarkerToSelection(e){this._selectedMarkerIds.has(e)||(this._selectedMarkerIds.add(e),this.updateSprites(),this.emitSelected())}removeMarkerFromSelection(e){this._selectedMarkerIds.delete(e)&&(this.updateSprites(),this.emitSelected())}setSelectedMarkers(e){this._selectedMarkerIds.clear(),(null==e?void 0:e.length)&&e.forEach((e=>this._selectedMarkerIds.add(e))),this.updateSprites(),this.emitSelected()}resetSelectedMarkers(){this._selectedMarkerIds.size&&(this._selectedMarkerIds.clear(),this.updateSprites(),this.emitSelected())}getMarkerAtCanvasPoint(e){if(this._markers.length){const t=this._spriteSize/2;for(let s=this._markers.length-1;s>=0;s--){const i=this._markers[s];if(this._tempVec3.set(i.position.x,i.position.y_Yup,i.position.z_Yup).applyMatrix4(this._hudProjectionMatrix),!(this._tempVec3.z>1)&&(this._tempVec2.set(this._tempVec3.x,this._tempVec3.y),this._tempVec2.distanceTo(e)<t))return i}}return null}initSprites(){const{texture:e,uvMap:t}=oe.buildSpriteAtlasTexture();this._uvMap=t,this.addHudElement(new _e(this._hudProjectionMatrix,this._hudResolution,e,this._spriteSize,this._toolZIndex,this._cameraZIndex,!0,1e3),"s_warn")}updateSprites(){this._markers.sort(((e,t)=>e.type===t.type?0:e.type>t.type?1:-1));const e=new Array(this._markers.length);let t=0;this._markers.forEach((s=>{e[t++]={position:s.position,scale:this._highlightedMarker===s?1.5:this._selectedMarkerIds.has(s.id)?1.25:1,uv:this._uvMap.get(s.type)}})),this.getHudElement("s_warn").set(e)}emitMarkers(){this._markersChange.next(this._markers)}emitHighlighted(){this._markersHighlightChange.next(this._highlightedMarker)}emitSelected(){this._markersManualSelectionChange.next(this._markers.filter((e=>this._selectedMarkerIds.has(e.id))))}}class xe{constructor(){this._cameraZ=10,this._scene=new L,this._hudResolution=new P,this._hudScale=new R,this._hudProjectionMatrix=new R,this.projectToHud=e=>{e.applyMatrix4(this._hudProjectionMatrix),e.z>1&&(e.x=-e.x,e.y=-e.y)},this._pointSnap=new ye(this._scene,this._hudResolution,this._hudProjectionMatrix,9,this._cameraZ),this._distanceMeasurer=new Me(this._scene,this._hudResolution,this._hudProjectionMatrix,8,this._cameraZ),this._markers=new ve(this._scene,this._hudResolution,this._hudProjectionMatrix,1,this._cameraZ)}get pointSnap(){return this._pointSnap}get distanceMeasurer(){return this._distanceMeasurer}get markers(){return this._markers}destroy(){this._pointSnap.destroy(),this._pointSnap=null,this._distanceMeasurer.destroy(),this._distanceMeasurer=null,this._markers.destroy(),this._markers=null,this._scene=null}render(e,t){const s=t.getContext();this.updateResolution(s.drawingBufferWidth,s.drawingBufferHeight),this.updateHudProjectionMatrix(e),this._distanceMeasurer.update(),t.autoClear=!1,t.clearDepth(),t.render(this._scene,this._camera),t.autoClear=!0}updateResolution(e,t){e===this._hudResolution.x&&t===this._hudResolution.y||(this._hudResolution.set(e,t),this.updateCameraResolution())}updateCameraResolution(){this._camera?(this._camera.left=this._hudResolution.x/-2,this._camera.right=this._hudResolution.x/2,this._camera.top=this._hudResolution.y/2,this._camera.bottom=this._hudResolution.y/-2,this._camera.updateProjectionMatrix()):(this._camera=new k(this._hudResolution.x/-2,this._hudResolution.x/2,this._hudResolution.y/2,this._hudResolution.y/-2,1,10),this._camera.position.setZ(this._cameraZ))}updateHudProjectionMatrix(e){this._hudScale.makeScale(this._hudResolution.x/2,this._hudResolution.y/2,1),this._hudProjectionMatrix.copy(this._hudScale).multiply(e.projectionMatrix).multiply(e.matrixWorldInverse)}}class fe{constructor(){this._raycaster=new E}static convertClientToCanvas(e,t,s){const i=e.domElement.getBoundingClientRect(),n=e.getPixelRatio(),r=(t-i.left)*(e.domElement.width/i.width)*n||0,o=(s-i.top)*(e.domElement.height/i.height)*n||0;return new P(r,o)}static convertClientToCanvasZeroCenter(e,t,s){const i=e.domElement.getBoundingClientRect(),n=e.getPixelRatio(),r=e.domElement.width/i.width*n||0,o=e.domElement.height/i.height*n||0,a=(t-i.left)*r,h=(s-i.top)*o,l=i.width*r,d=i.height*o;return new P(a-l/2,d/2-h)}static convertWorldToCanvas(e,t,s){const n=(new i).copy(s).project(e),r=t.domElement.getBoundingClientRect(),o=t.domElement.width/(t.domElement.width/r.width)||0,a=t.domElement.height/(t.domElement.height/r.height)||0,h=(n.x+1)*o/2,l=(n.y-1)*a/-2;return new P(h,l)}static convertWorldToCanvasZeroCenter(e,t,s){const n=(new i).copy(s).project(e);n.z>1&&(n.x=-n.x,n.y=-n.y);const r=t.domElement.getBoundingClientRect(),o=t.domElement.width/(t.domElement.width/r.width)||0,a=t.domElement.height/(t.domElement.height/r.height)||0,h=n.x*o/2,l=n.y*a/2;return new P(h,l)}destroy(){}getMeshSnapPointAtPosition(e,t,s,i){if(!i)return null;const n=t.getContext(),r=s.x/n.drawingBufferWidth*2-1,o=s.y/n.drawingBufferHeight*-2+1;return this.getPoint(e,i,new P(r,o))}getPoint(e,t,s){this._raycaster.setFromCamera(s,e);const n=this._raycaster.intersectObject(t)[0];if(!n)return null;const r=(new i).copy(n.point);n.object.worldToLocal(r);const o=(new i).copy(this.getNearestVertex(t,r,n.face));return o?(n.object.localToWorld(o),o):null}getNearestVertex(e,t,s){const n=(new i).fromBufferAttribute(e.geometry.attributes.position,s.a),r=(new i).fromBufferAttribute(e.geometry.attributes.position,s.b),o=(new i).fromBufferAttribute(e.geometry.attributes.position,s.c),a=new i;return new H(n,r,o).getBarycoord(t,a),a.x>a.y&&a.x>a.z?n:a.y>a.x&&a.y>a.z?r:a.z>a.x&&a.z>a.y?o:null}}var Se=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{h(i.next(e))}catch(e){r(e)}}function a(e){try{h(i.throw(e))}catch(e){r(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class we{constructor(s,i,n){if(this._optionsChange=new e(null),this._selectionChange=new e(new Set),this._manualSelectionChange=new t,this._lastFrameTime=new e(0),this._subscriptions=[],this._meshesNeedColorUpdate=new Set,this._pointerEventHelper=X.default,this._queuedColoring=null,this._queuedSelection=null,this._highlightedMesh=null,this._selectedMeshes=[],this._isolatedMeshes=[],this._coloredMeshes=[],this._interactionMode="select_mesh",this.onCanvasMouseMove=e=>{e.buttons||(clearTimeout(this._pointerEventHelper.mouseMoveTimer),this._pointerEventHelper.mouseMoveTimer=null,this._pointerEventHelper.mouseMoveTimer=window.setTimeout((()=>{const t=e.clientX,s=e.clientY;switch(this._interactionMode){case"select_mesh":this.highlightMeshAtPoint(t,s);break;case"select_vertex":this.highlightMeshAtPoint(t,s),this.setVertexSnapAtPoint(t,s);break;case"select_sprite":this.highlightSpriteAtPoint(t,s);break;case"measure_distance":this.setVertexSnapAtPoint(t,s)}}),30))},this.onCanvasPointerDown=e=>{this._pointerEventHelper.downX=e.clientX,this._pointerEventHelper.downY=e.clientY},this.onCanvasPointerUp=e=>{const t=e.clientX,s=e.clientY;if(!(!this._pointerEventHelper.downX||Math.abs(t-this._pointerEventHelper.downX)>this._pointerEventHelper.maxDiff||Math.abs(s-this._pointerEventHelper.downY)>this._pointerEventHelper.maxDiff)){switch(this._interactionMode){case"select_mesh":this._pointerEventHelper.waitForDouble?(this.isolateSelectedMeshes(),this._pointerEventHelper.waitForDouble=!1):(this._pointerEventHelper.waitForDouble=!0,setTimeout((()=>{this._pointerEventHelper.waitForDouble=!1}),300),this.selectMeshAtPoint(t,s,e.ctrlKey));break;case"select_vertex":this.selectVertexAtPoint(t,s);break;case"select_sprite":this.selectSpriteAtPoint(t,s);break;case"measure_distance":this.measureDistanceAtPoint(t,s)}this._pointerEventHelper.downX=null,this._pointerEventHelper.downY=null}},this.resizeRenderer=()=>{var e;const{width:t,height:s}=this._container.getBoundingClientRect();null===(e=this._cameraControls)||void 0===e||e.resize(t,s),this._renderer&&(this._renderer.setSize(t,s,!1),this.render())},this.initObservables(),this._container=document.getElementById(s),!this._container)throw new Error("Container not found!");this._options=new J(n),this._optionsChange.next(this._options),this._lights=new ne(this._options.usePhysicalLights,this._options.ambientLightIntensity,this._options.hemiLightIntensity,this._options.dirLightIntensity),this._pointSnapHelper=new fe,this._pickingScene=new ue,this._renderScene=new le(this._options.isolationColor,this._options.isolationOpacity,this._options.selectionColor,this._options.highlightColor),this._simplifiedScene=new ce,this.initHud(),this.initLoader(i),this.initRenderer(),this._axes=new ae(this._container,(e=>this._cameraControls.rotateAroundAxis(e,!0)),this._options.axesHelperEnabled,this._options.axesHelperPlacement,this._options.axesHelperSize),this._containerResizeObserver=new ResizeObserver(this.resizeRenderer),this._containerResizeObserver.observe(this._container)}destroy(){var e,t,s,i,n,r,o,a,h,l;this._subscriptions.forEach((e=>e.unsubscribe())),this.closeSubjects(),this.removeCanvasEventListeners(),null===(e=this._containerResizeObserver)||void 0===e||e.disconnect(),this._containerResizeObserver=null,null===(t=this._cameraControls)||void 0===t||t.destroy(),this._cameraControls=null,null===(s=this._pointSnapHelper)||void 0===s||s.destroy(),this._pointSnapHelper=null,null===(i=this._axes)||void 0===i||i.destroy(),this._axes=null,null===(n=this._hudScene)||void 0===n||n.destroy(),this._hudScene=null,null===(r=this._pickingScene)||void 0===r||r.destroy(),this._pickingScene=null,null===(o=this._simplifiedScene)||void 0===o||o.destroy(),this._simplifiedScene=null,null===(a=this._renderScene)||void 0===a||a.destroy(),this._renderScene=null,null===(h=this._loader)||void 0===h||h.destroy(),this._loader=null,null===(l=this._renderer)||void 0===l||l.dispose(),this._renderer=null}updateOptionsAsync(e){return Se(this,void 0,void 0,(function*(){const t=this._options;this._options=new J(e);let s=!1,i=!1,n=!1,r=!1,o=!1,a=!1;return this._options.useAntialiasing!==t.useAntialiasing&&(this.initRenderer(),s=!0),this._options.axesHelperEnabled===t.axesHelperEnabled&&this._options.axesHelperPlacement===t.axesHelperPlacement&&this._options.axesHelperSize===t.axesHelperSize||(this._axes.updateOptions(this._options.axesHelperEnabled,this._options.axesHelperPlacement,this._options.axesHelperSize),i=!0),this._options.usePhysicalLights===t.usePhysicalLights&&this._options.ambientLightIntensity===t.ambientLightIntensity&&this._options.hemiLightIntensity===t.hemiLightIntensity&&this._options.dirLightIntensity===t.dirLightIntensity||(this._renderer.physicallyCorrectLights=this._options.usePhysicalLights,this._lights.update(this._options.usePhysicalLights,this._options.ambientLightIntensity,this._options.hemiLightIntensity,this._options.dirLightIntensity),n=!0),this._options.isolationColor===t.isolationColor&&this._options.isolationOpacity===t.isolationOpacity&&this._options.selectionColor===t.selectionColor&&this._options.highlightColor===t.highlightColor||(this._renderScene.updateCommonColors(this._options.isolationColor,this._options.isolationOpacity,this._options.selectionColor,this._options.highlightColor),r=!0),(s||n||r)&&(this._renderScene.updateSceneMaterials(),this._simplifiedScene.updateSceneMaterials(),o=!0),this._options.meshMergeType===t.meshMergeType&&this._options.fastRenderType===t.fastRenderType||(yield this.updateRenderSceneAsync(),a=!0),o||a||!i||this.render(),this._options.highlightingEnabled!==t.highlightingEnabled&&(this._options.highlightingEnabled?this._renderer.domElement.addEventListener("mousemove",this.onCanvasMouseMove):this._renderer.domElement.removeEventListener("mousemove",this.onCanvasMouseMove)),this._optionsChange.next(this._options),this._options}))}setInteractionMode(e){if(this._interactionMode!==e){switch(this._interactionMode){case"select_mesh":break;case"select_vertex":this._hudScene.pointSnap.reset();break;case"select_sprite":this._hudScene.markers.highlightMarker(null),this._hudScene.markers.resetSelectedMarkers();break;case"measure_distance":this._hudScene.pointSnap.reset(),this._hudScene.distanceMeasurer.reset();break;default:return}this._interactionMode=e,this.render()}}openModelsAsync(e){return Se(this,void 0,void 0,(function*(){return this._loader.openModelsAsync(e)}))}closeModelsAsync(e){return Se(this,void 0,void 0,(function*(){return this._loader.closeModelsAsync(e)}))}getOpenedModels(){return this._loader.openedModelInfos}colorItems(e){this._loader.loadingInProgress?this._queuedColoring=e:this.resetSelectionAndColorMeshes(e)}selectItems(e){(null==e?void 0:e.length)&&(this._loader.loadingInProgress?this._queuedSelection={ids:e,isolate:!1}:this.findAndSelectMeshes(e,!1))}isolateItems(e){(null==e?void 0:e.length)&&(this._loader.loadingInProgress?this._queuedSelection={ids:e,isolate:!0}:this.findAndSelectMeshes(e,!0))}zoomToItems(e){if(null==e?void 0:e.length){const{found:t}=this._loader.findMeshesByIds(new Set(e));if(t.length)return void this.render(t)}this.renderWholeScene()}getSelectedItems(){return this._selectionChange.getValue()}setMarkers(e){var t;null===(t=this._hudScene)||void 0===t||t.markers.setMarkers(e)}initObservables(){this.optionsChange$=this._optionsChange.asObservable(),this.meshesSelectionChange$=this._selectionChange.asObservable(),this.meshesManualSelectionChange$=this._manualSelectionChange.asObservable(),this.lastFrameTime$=this._lastFrameTime.asObservable()}closeSubjects(){this._optionsChange.complete(),this._selectionChange.complete(),this._manualSelectionChange.complete(),this._lastFrameTime.complete()}addCanvasEventListeners(){const{highlightingEnabled:e}=this._options;this._renderer.domElement.addEventListener("pointerdown",this.onCanvasPointerDown),this._renderer.domElement.addEventListener("pointerup",this.onCanvasPointerUp),e&&this._renderer.domElement.addEventListener("mousemove",this.onCanvasMouseMove)}removeCanvasEventListeners(){this._renderer.domElement.removeEventListener("pointerdown",this.onCanvasPointerDown),this._renderer.domElement.removeEventListener("pointerup",this.onCanvasPointerUp),this._renderer.domElement.removeEventListener("mousemove",this.onCanvasMouseMove)}initLoader(e){this._loader=new se(e,(()=>Se(this,void 0,void 0,(function*(){this.runQueuedColoring(),this.runQueuedSelection(),yield this.updateRenderSceneAsync()}))),(e=>{}),(e=>{this._highlightedMesh=null,this._selectedMeshes=this._selectedMeshes.filter((t=>t.userData.modelGuid!==e)),this._isolatedMeshes=this._isolatedMeshes.filter((t=>t.userData.modelGuid!==e)),this._coloredMeshes=this._coloredMeshes.filter((t=>t.userData.modelGuid!==e))}),(e=>{this._pickingScene.add(e)}),(e=>{this._pickingScene.remove(e)})),this.loadingStateChange$=this._loader.loadingStateChange$,this.modelLoadingStart$=this._loader.modelLoadingStart$,this.modelLoadingEnd$=this._loader.modelLoadingEnd$,this.modelLoadingProgress$=this._loader.modelLoadingProgress$,this.modelsOpenedChange$=this._loader.modelsOpenedChange$}initRenderer(){this._renderer&&(this.removeCanvasEventListeners(),this._renderer.domElement.remove(),this._renderer.dispose(),this._renderer.forceContextLoss(),this._renderer=null);const{useAntialiasing:e,usePhysicalLights:t}=this._options,s=new D({alpha:!0,antialias:e});s.setClearColor(0,0),s.outputEncoding=O,s.toneMapping=j,s.physicallyCorrectLights=t,this._renderer=s,this.resizeRenderer(),this.addCanvasEventListeners(),this._cameraControls?this._cameraControls.focusCameraOnObjects(null):this._cameraControls=new ie(this._container,(()=>this.renderOnCameraMove())),this._container.append(this._renderer.domElement)}updateRenderSceneAsync(){return Se(this,void 0,void 0,(function*(){yield this._renderScene.updateSceneAsync(this._lights.getLights(),this._loader.loadedMeshesArray,this._loader.loadedModelsArray,this._options.meshMergeType),this._options.fastRenderType?yield this._simplifiedScene.updateSceneAsync(this._lights.getCopy(),this._loader.loadedMeshesArray,this._options.fastRenderType):this._simplifiedScene.clearScene(),this.renderWholeScene()}))}prepareToRender(e=null){(null==e?void 0:e.length)&&this._cameraControls.focusCameraOnObjects(e),this._meshesNeedColorUpdate.size&&(this._renderScene.updateMeshColors(this._meshesNeedColorUpdate),this._meshesNeedColorUpdate.clear())}render(e=null,t=!1){this.prepareToRender(e),requestAnimationFrame((()=>{var e,s,i,n;if(!this._renderer)return;const r=performance.now();t&&(null===(e=this._simplifiedScene)||void 0===e?void 0:e.scene)?this._renderer.render(this._simplifiedScene.scene,this._cameraControls.camera):(null===(s=this._renderScene)||void 0===s?void 0:s.scene)&&this._renderer.render(this._renderScene.scene,this._cameraControls.camera),null===(i=this._hudScene)||void 0===i||i.render(this._cameraControls.camera,this._renderer),null===(n=this._axes)||void 0===n||n.render(this._cameraControls.camera,this._renderer);const o=performance.now()-r;this._lastFrameTime.next(o)}))}renderWholeScene(){this.render(this._loader.loadedMeshesArray.length?[this._renderScene.scene]:null)}renderOnCameraMove(){this._options.fastRenderType?(this._deferRender&&(clearTimeout(this._deferRender),this._deferRender=null),this.render(null,!0),this._deferRender=window.setTimeout((()=>{this._deferRender=null,this.render()}),300)):this.render()}runQueuedColoring(){this._queuedColoring&&this.resetSelectionAndColorMeshes(this._queuedColoring)}resetSelectionAndColorMeshes(e){this.resetSelection(),this.colorMeshes(e)}colorMeshes(e){if(this.removeColoring(),null==e?void 0:e.length)for(const t of e){const e=new y(t.color),s=new ee(e.r,e.g,e.b,1,0,t.opacity);t.ids.forEach((e=>{const t=this._loader.getLoadedMeshesById(e);(null==t?void 0:t.length)&&t.forEach((e=>{e.userData.colored=!0,ee.setCustomToMesh(e,s),this._meshesNeedColorUpdate.add(e),this._coloredMeshes.push(e)}))}))}this.render()}removeColoring(){for(const e of this._coloredMeshes)e.userData.colored=void 0,ee.deleteFromMesh(e,!0),this._meshesNeedColorUpdate.add(e);this._coloredMeshes.length=0}getMeshAt(e,t){const s=fe.convertClientToCanvas(this._renderer,e,t);return this._renderer&&this._pickingScene?this._pickingScene.getSourceMeshAt(this._cameraControls.camera,this._renderer,s):null}getSnapPointAt(e,t){const s=fe.convertClientToCanvas(this._renderer,e,t),i=this._pickingScene.getPickingMeshAt(this._cameraControls.camera,this._renderer,s),n=i?this._pointSnapHelper.getMeshSnapPointAtPosition(this._cameraControls.camera,this._renderer,s,i):null;return n?{meshId:i.userData.sourceId,position:q.fromVector3(n)}:null}initHud(){this._hudScene=new xe,this.snapPointHighlightChange$=this._hudScene.pointSnap.snapPointHighlightChange$,this.snapPointManualSelectionChange$=this._hudScene.pointSnap.snapPointManualSelectionChange$,this.markersChange$=this._hudScene.markers.markersChange$,this.markersManualSelectionChange$=this._hudScene.markers.markersManualSelectionChange$,this.markersHighlightChange$=this._hudScene.markers.markersHighlightChange$,this.distanceMeasureChange$=this._hudScene.distanceMeasurer.distanceMeasureChange$}setVertexSnapAtPoint(e,t){if(!this._renderer||!this._pickingScene)return;const s=this.getSnapPointAt(e,t);this._hudScene.pointSnap.setSnapPoint(s),this.render()}selectVertexAtPoint(e,t){if(!this._renderer||!this._pickingScene)return;const s=this.getSnapPointAt(e,t);this._hudScene.pointSnap.setSelectedSnapPoints(s?[s]:null),this.render()}highlightSpriteAtPoint(e,t){if(!this._renderer||!this._pickingScene)return;const s=fe.convertClientToCanvasZeroCenter(this._renderer,e,t),i=this._hudScene.markers.getMarkerAtCanvasPoint(s);this._hudScene.markers.highlightMarker(i),this.render()}selectSpriteAtPoint(e,t){if(!this._renderer||!this._pickingScene)return;const s=fe.convertClientToCanvasZeroCenter(this._renderer,e,t),i=this._hudScene.markers.getMarkerAtCanvasPoint(s);this._hudScene.markers.setSelectedMarkers(i?[i.id]:null),this.render()}measureDistanceAtPoint(e,t){if(!this._renderer||!this._pickingScene)return;const s=this.getSnapPointAt(e,t);this._hudScene.distanceMeasurer.setEndMarker(null==s?void 0:s.position.toVector3()),this.render()}runQueuedSelection(){if(this._queuedSelection){const{ids:e,isolate:t}=this._queuedSelection;this.findAndSelectMeshes(e,t)}}findAndSelectMeshes(e,t){const{found:s}=this._loader.findMeshesByIds(new Set(e));s.length&&this.selectMeshes(s,!1,t)}removeSelection(){for(const e of this._selectedMeshes)e.userData.selected=void 0,this._meshesNeedColorUpdate.add(e);this._selectedMeshes.length=0}removeIsolation(){for(const e of this._isolatedMeshes)e.userData.isolated=void 0,this._meshesNeedColorUpdate.add(e);this._isolatedMeshes.length=0}resetSelection(){this.removeSelection(),this.removeIsolation()}selectMeshAtPoint(e,t,s){const i=this.getMeshAt(e,t);i?s?i.userData.selected?this.removeFromSelection(i):this.addToSelection(i):this.selectMeshes([i],!0,!1):this.selectMeshes([],!0,!1)}addToSelection(e){const t=[e,...this._selectedMeshes];return this.selectMeshes(t,!0,!1),!0}removeFromSelection(e){const t=this._selectedMeshes.filter((t=>t!==e));return this.selectMeshes(t,!0,!1),!0}selectMeshes(e,t,s){if(this.resetSelection(),!(null==e?void 0:e.length))return this.emitSelectionChanged(t,!0),null;e.forEach((e=>{e.userData.selected=!0,this._meshesNeedColorUpdate.add(e)})),this._selectedMeshes=e,s?(this.emitSelectionChanged(t,!1),this.isolateSelectedMeshes()):this.emitSelectionChanged(t,!0)}isolateSelectedMeshes(){this._selectedMeshes.length&&(this._loader.loadedMeshesArray.forEach((e=>{e.userData.selected||(e.userData.isolated=!0,this._meshesNeedColorUpdate.add(e),this._isolatedMeshes.push(e))})),this.render(this._selectedMeshes))}emitSelectionChanged(e,t){t&&this.render(e?null:this._selectedMeshes);const s=new Set;this._selectedMeshes.forEach((e=>s.add(e.userData.id))),this._selectionChange.next(s),e&&this._manualSelectionChange.next(s)}highlightMeshAtPoint(e,t){const s=this.getMeshAt(e,t);this.highlightItem(s)}highlightItem(e){e!==this._highlightedMesh&&(this.removeHighlighting(),e&&(e.userData.highlighted=!0,this._meshesNeedColorUpdate.add(e),this._highlightedMesh=e),this.render())}removeHighlighting(){if(this._highlightedMesh){const e=this._highlightedMesh;e.userData.highlighted=void 0,this._meshesNeedColorUpdate.add(e),this._highlightedMesh=null}}}export{K as Distance,we as GltfViewer,J as GltfViewerOptions,q as Vec4DoubleCS};
